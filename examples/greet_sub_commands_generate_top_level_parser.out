#!/bin/bash

declare -r USAGE_TEXT_santa='santa -h [-w <whom>]'
declare -r OPT_USAGE_TEXT_santa='
  -w      The person whom santa should greet.'
declare -r USAGE_TEXT_mom='mom -h -w <whom>'
declare -r OPT_USAGE_TEXT_mom=''

parse_santa_args () 
{ 
    local __var_whom=;
    while getopts ':hw:' opt; do
        case $opt in 
            h)
                __bash_parse_die "Usage: greet $USAGE_TEXT_santa"
            ;;
            w)
                __var_whom=$OPTARG;
                __bash_parse_check_opt_arg "$__var_whom" || __bash_parse_die_required_arg '<whom>' "greet  $USAGE_TEXT_santa"
            ;;
            :)
                case $OPTARG in 
                    w)
                        __bash_parse_die_required_arg '<whom>' "greet $USAGE_TEXT_santa"
                    ;;
                esac
            ;;
            \?)
                __bash_parse_die "Unsupported option: -$OPTARG"
            ;;
        esac;
    done;
    echo "local whom='$__var_whom'; shift $((OPTIND - 1)); "
}

parse_mom_args () 
{ 
    local __var_whom=;
    [ $# -eq 0 ] && __bash_parse_die "Usage: greet $USAGE_TEXT_mom";
    while getopts ':hw:' opt; do
        case $opt in 
            h)
                __bash_parse_die "Usage: greet $USAGE_TEXT_mom"
            ;;
            w)
                __var_whom=$OPTARG;
                __bash_parse_check_opt_arg "$__var_whom" || __bash_parse_die_required_arg '<whom>' "greet  $USAGE_TEXT_mom"
            ;;
            :)
                case $OPTARG in 
                    w)
                        __bash_parse_die_required_arg '<whom>' "greet $USAGE_TEXT_mom"
                    ;;
                esac
            ;;
            \?)
                __bash_parse_die "Unsupported option: -$OPTARG"
            ;;
        esac;
    done;
    [ -z "$__var_whom" ] && __bash_parse_die_required_arg '<whom>' "greet $USAGE_TEXT_mom";
    echo "local whom='$__var_whom'; shift $((OPTIND - 1)); "
}

parse_top_level_args () 
{ 
    [ $# -eq 0 ] && echo 'Usage:''
''  greet santa -h [-w <whom>]
  greet mom -h -w <whom>

Options:
  -w      The person whom santa should greet.
' && exit 1;
    case "$1" in 
        santa)
            shift;
            santa "$@"
        ;;
        mom)
            shift;
            mom "$@"
        ;;
        *)
            echo '  greet santa -h [-w <whom>]
  greet mom -h -w <whom>

Options:
  -w      The person whom santa should greet.
' && exit 1
        ;;
    esac
}


set -u

#. ../src/bash_arg_parser



mom() {
    local get_args
    get_args=$(parse_mom_args "$@") || exit
    eval "$get_args"
 
    echo "Mom loves you, ${whom}!"
    echo "Remaining arguments: $@"
}

santa() {
    local get_args
    get_args=$(parse_santa_args "$@") || exit
    eval "$get_args"
    
    if [ -z "$whom" ]; then
        echo "Santa is sad and alone since there is noone to greet. You are a monster."
    else
        echo "Santa put $whom on his naughty list!"
    fi

    echo "Remaining arguments: $@"
}


parse_top_level_args "$@"
